---
import Base from "@/layouts/Base.astro";
import PageHeader from "@/components/widgets/PageHeader.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import { getCollectionCTM, getEntryCTM } from "@/lib/contentParser.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import config from ".astro/config.generated.json" assert { type: "json" };
import OptimizedImage from "@/components/utilities/OptimizedImage.astro";
import { render } from "astro:content";

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;

      const rateIndex = await getEntryCTM("rates", "-index", lang.languageCode);

      let rates = await getCollectionCTM("rates", lang.languageCode);

      // If draft true in index.md file frontmatter don't include any page related to this page collection in production
      if (rateIndex?.data.draft && import.meta.env.PROD) {
        return [];
      }

      return rates.map((rate) => ({
        params: {
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
          single:
            rate.data?.customSlug ||
            rate.id
              .replace(/\.mdx?|\.md/g, "")
              .split("/")
              .pop(),
        },
        props: {
          rate,
          rateIndex,
        },
      }));
    }),
  );

  return paths.flat();
}

const { rate, rateIndex: entry } = Astro.props;
const { Content } = rate ? await render(rate) : { Content: null };
---

<Base {...rate.data}>
  <PageHeader {...rate.data} />

  {
    rate?.data?.image && (
      <OptimizedImage
        src={rate.data.image as string}
        alt={rate.data.title}
        class="h-64 w-full object-cover md:h-96"
      />
    )
  }

  {
    rate && Content && (
      <article class="prose prose-lg mx-auto my-12 max-w-7xl">
        <Content />
      </article>
    )
  }
</Base>
