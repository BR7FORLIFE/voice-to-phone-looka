---
import Base from "@/layouts/Base.astro";
import PageHeader from "@/components/widgets/PageHeader.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import { getCollectionCTM, getEntryCTM } from "@/lib/contentParser.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import config from ".astro/config.generated.json" assert { type: "json" };

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;

      const index = await getEntryCTM(
        "rate-virtual-number-by-country",
        "-index",
        lang.languageCode,
      );

      let pages = await getCollectionCTM(
        "rate-virtual-number-by-country",
        lang.languageCode,
      );

      // Exclude index entries (works for .md and .mdx)
      pages = pages.filter(
        (p) => !p.id.replace(/\.(md|mdx)$/, "").endsWith("-index"),
      );

      // If draft true in index.md file frontmatter don't include any page related to this page collection in production
      if (index?.data.draft && import.meta.env.PROD) {
        return [];
      }

      return pages.map((page) => ({
        params: {
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
          single:
            page.data?.customSlug ||
            page.id
              .replace(/\.mdx?|\.md/g, "")
              .split("/")
              .pop(),
        },
        props: {
          page,
          pageIndex: index,
        },
      }));
    }),
  );

  return paths.flat();
}

const { page, pageIndex: entry } = Astro.props;
const { Content } = page ? await page.render() : { Content: null };
---

<Base {...page.data}>
  <PageHeader {...page.data} />

  <section>
    <div class="container">
      <div class="prose-styles mx-auto max-w-3xl">
        {page && Content && <Content />}
      </div>
    </div>
  </section>

  <CallToAction />
</Base>
